stages:
  - download
  - build

variables:
  DOCKER_BUILDKIT: 1
  ARCHITECTURES: "linux/amd64,linux/arm64,linux/ppc64le,linux/s390x,linux/386"


########################################################################################################################
#                                                                                                                      #
#                                                  Bootstrap build.                                                    #
#                                                                                                                      #
# Due to the fact that Go requires Go to compile, a bootstrap image is required. The following build steps are made to #
# only build the bootstrap file and push it to the registry. It's only built when required, not always.                #
#                                                                                                                      #
########################################################################################################################

download:bootstrap:
  stage: download
  image: registry.gitlab.com/jitesoft/dockerfiles/alpine:latest
  variables:
    GIT_STRATEGY: none
    SHA: "f4ff5b5eb3a3cae1c993723f3eab519c5bae18866b5e5f96fe1102f0cb5c3e52  go1.4-bootstrap-20171003.tar.gz"
    SHA2: "4c189111e9ba651a2bb3ee868aa881fab36b2f2da3409e80885ca758a6b614cc  go1.7.4.src.tar.gz"
  script:
    - wget https://dl.google.com/go/go1.4-bootstrap-20171003.tar.gz
    - wget https://dl.google.com/go/go1.7.4.src.tar.gz
    - echo "${SHA}" > shasum.txt
    - echo "${SHA2}" > shasum.txt
    - sha256sum -c shasum.txt
  artifacts:
    paths:
      - go1.4-bootstrap-20171003.tar.gz
      - go1.7.4.src.tar.gz
    expire_in: 5 hours
  only:
    refs:
      - bootstrap

build:bootstrap:alpine:
  stage: build
  dependencies:
    - download:bootstrap
  image: registry.gitlab.com/jitesoft/dockerfiles/docker/buildx:latest
  script:
    - docker buildx build --platform ${ARCHITECTURES} --progress plain --push -t ${CI_REGISTRY_IMAGE}:bootstrap -f Alpine/Dockerfile .
  only:
    refs:
      - bootstrap
  tags: [ jitesoft, buildx, amd64, arm64, s390x, ppc64le, i386 ]

build:bootstrap:ubuntu:
  stage: build
  dependencies:
    - download:bootstrap
  image: registry.gitlab.com/jitesoft/dockerfiles/docker/buildx:latest
  script:
    - docker buildx build --platform ${ARCHITECTURES} --progress plain --push -t ${CI_REGISTRY_IMAGE}/ubuntu:bootstrap -f Alpine/Dockerfile .
  only:
    refs:
      - bootstrap
  tags: [ jitesoft, buildx, amd64, arm64, s390x, ppc64le, i386 ]
