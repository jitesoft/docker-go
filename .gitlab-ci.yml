include:
  - https://gitlab.com/jitesoft/gitlab-ci-lib/raw/master/container_scan.yml


variables:
  DOCKER_BUILDKIT: 1

stages:
  - pre
  - download
  - build
  - scan

download:versions:
  image: registry.gitlab.com/jitesoft/dockerfiles/alpine:latest
  stage: pre
  variables:
    GIT_STRATEGY: none
  before_script:
    - apk add --no-cache libxml2-utils grep
  script:
    - VERSIONS=$(wget -qO- https://golang.org/dl/ | grep -oP "(?<=go)([0-9]{0,3}[.][0-9]{0,3}([.][0-9]{0,3})?)(?=.linux)" | sort -V -r -u - | head -n2)
    - |
      for VERSION in ${VERSIONS}; do
        OUTPUT=$(wget -qO- https://golang.org/dl/ | xmllint --html --xpath "//a[contains(@class, 'download') and contains(@href, 'go${VERSION}.src.tar.gz') and not(contains(@class, 'downloadBox'))]/parent::td/following-sibling::td[5]/tt/text()" - 2>/dev/null)
        echo "${OUTPUT} go${VERSION}.src.tar.gz" >> sha256sum.txt
      done
  artifacts:
    paths:
      - sha256sum.txt
    expire_in: 1 day
  only:
    refs:
      - master

download:src:
  image: registry.gitlab.com/jitesoft/dockerfiles/alpine:latest
  stage: download
  variables:
    GIT_STRATEGY: none
  dependencies:
    - download:versions
  before_script:
    - apk add --no-cache coreutils
  script:
    - cat sha256sum.txt
    - |
      while read -r line
      do
        set -- $line
        wget "https://dl.google.com/go/${2}"
      done <"sha256sum.txt"
    - sha256sum -c sha256sum.txt
  artifacts:
    paths:
      - ${CI_PROJECT_DIR}/*.src.tar.gz
    expire_in: 1 day
  only:
    refs:
      - master

.build:alpine:
  dependencies:
    - download:src
    - download:versions
  stage: build
  image: registry.gitlab.com/jitesoft/dockerfiles/docker:latest
  script:
    - docker build --build-arg VERSION=${VERSION} --label "com.jitesoft.app.go.version=${VERSION}" -t ${CI_REGISTRY_IMAGE}:${VERSION} -f Alpine/Dockerfile .
    - VERSION_SHORT=""
    - OC=$(echo ${VERSION} | awk -F"." '{print NF-1}')
    - if [ "$OC" = "2" ]; then VERSION_SHORT=$(echo ${VERSION} | cut -d'.' -f1,2); fi
    - TAGS="${TAGS} ${VERSION} ${VERSION_SHORT}"
    - |
      for tag in $TAGS; do
        docker tag ${CI_REGISTRY_IMAGE}:${VERSION} ${CI_REGISTRY_IMAGE}:${tag}
        docker tag ${CI_REGISTRY_IMAGE}:${VERSION} jitesoft/go:${tag}
        docker tag ${CI_REGISTRY_IMAGE}:${VERSION} quay.io/jitesoft/go:${tag}
        docker push ${CI_REGISTRY_IMAGE}:${tag}
        docker push jitesoft/go:${tag}
        docker push quay.io/jitesoft/go:${tag}
      done
  only:
    refs:
      - master

.build:ubuntu:
  dependencies:
    - download:src
    - download:versions
  stage: build
  image: registry.gitlab.com/jitesoft/dockerfiles/docker:latest
  script:
    - docker build --build-arg VERSION=${VERSION} --label "com.jitesoft.app.go.version=${VERSION}" -t ${CI_REGISTRY_IMAGE}/ubuntu:${VERSION} -f Ubuntu/Dockerfile .
    - TAGS="${TAGS} ${VERSION} $(echo ${VERSION} | cut -d'.' -f1,2)"
    - |
      for tag in $TAGS; do
        docker tag ${CI_REGISTRY_IMAGE}/ubuntu:${VERSION} ${CI_REGISTRY_IMAGE}/ubuntu:${tag}
        docker tag ${CI_REGISTRY_IMAGE}/ubuntu:${VERSION} jitesoft/go:${tag}-ubuntu
        docker tag ${CI_REGISTRY_IMAGE}/ubuntu:${VERSION} quay.io/jitesoft/go:${tag}-ubuntu
        docker push ${CI_REGISTRY_IMAGE}/ubuntu:${tag}
        docker push jitesoft/go:${tag}-ubuntu
        docker push quay.io/jitesoft/go:${tag}-ubuntu
      done
  only:
    refs:
      - master

build:current:ubuntu:
  variables:
    TAGS: "latest"
  extends: .build:ubuntu
  before_script:
    - apk add --no-cache grep
    - FILE=$(cat sha256sum.txt | awk '{print $2}' | head -1)
    - VERSION=$(echo ${FILE} | grep -oP '([0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3})')

build:prev:ubuntu:
  variables:
    TAGS: "prev"
  extends: .build:ubuntu
  before_script:
    - apk add --no-cache grep
    - FILE=$(cat sha256sum.txt | awk '{print $2}' | tail -1)
    - VERSION=$(echo ${FILE} | grep -oP '([0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3})')

build:current:alpine:
  variables:
    TAGS: "latest"
  extends: .build:alpine
  before_script:
    - apk add --no-cache grep
    - FILE=$(cat sha256sum.txt | awk '{print $2}' | head -1)
    - VERSION=$(echo ${FILE} | grep -oP '([0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3})')

build:prev:alpine:
  variables:
    TAGS: "prev"
  extends: .build:alpine
  before_script:
    - apk add --no-cache grep
    - FILE=$(cat sha256sum.txt | awk '{print $2}' | tail -1)
    - VERSION=$(echo ${FILE} | grep -oP '([0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3})')

scan:current:ubuntu:
  needs:
    - "build:current:ubuntu"
  stage: scan
  extends: .container_scanning
  variables:
    SCANNING_IMAGE_NAME: "${CI_REGISTRY_IMAGE}/ubuntu:latest"
    GIT_STRATEGY: none

scan:prev:ubuntu:
  needs:
    - "build:prev:ubuntu"
  stage: scan
  extends: .container_scanning
  variables:
    SCANNING_IMAGE_NAME: "${CI_REGISTRY_IMAGE}/ubuntu:prev"
    GIT_STRATEGY: none

scan:current:alpine:
  needs:
    - "build:current:alpine"
  stage: scan
  extends: .container_scanning
  variables:
    SCANNING_IMAGE_NAME: "${CI_REGISTRY_IMAGE}:latest"
    GIT_STRATEGY: none

scan:prev:alpine:
  needs:
    - "build:prev:alpine"
  stage: scan
  extends: .container_scanning
  variables:
    SCANNING_IMAGE_NAME: "${CI_REGISTRY_IMAGE}:prev"
    GIT_STRATEGY: none

########################################################################################################################
#                                                                                                                      #
#                                                  Bootstrap build.                                                    #
#                                                                                                                      #
# Due to the fact that Go requires Go to compile, a bootstrap image is required. The following build steps are made to #
# only build the bootstrap file and push it to the registry. It's only built when required, not always.                #
#                                                                                                                      #
########################################################################################################################

download:bootstrap:
  stage: download
  image: registry.gitlab.com/jitesoft/dockerfiles/alpine:latest
  variables:
    GIT_STRATEGY: none
    SHA: "f4ff5b5eb3a3cae1c993723f3eab519c5bae18866b5e5f96fe1102f0cb5c3e52  go1.4-bootstrap-20171003.tar.gz"
  script:
    - wget https://dl.google.com/go/go1.4-bootstrap-20171003.tar.gz
    - echo "${SHA}" > shasum.txt
    - sha256sum -c shasum.txt
  artifacts:
    paths:
      - go1.4-bootstrap-20171003.tar.gz
    expire_in: 5 hours
  only:
    refs:
      - bootstrap

build:bootstrap:alpine:
  stage: build
  dependencies:
    - download:bootstrap
  image: registry.gitlab.com/jitesoft/dockerfiles/docker:latest
  script:
    - docker build -t ${CI_REGISTRY_IMAGE}:bootstrap -f bootstrap.dockerfile .
    - docker push ${CI_REGISTRY_IMAGE}:bootstrap
  only:
    refs:
      - bootstrap

build:bootstrap:ubuntu:
  stage: build
  dependencies:
    - download:bootstrap
  image: registry.gitlab.com/jitesoft/dockerfiles/docker:latest
  script:
    - docker build -t ${CI_REGISTRY_IMAGE}:bootstrap -f bootstrap-ubuntu.dockerfile .
    - docker push ${CI_REGISTRY_IMAGE}/ubuntu:bootstrap
  only:
    refs:
      - bootstrap
